{% extends "base.html" %}
{% block content %}
<h2 class="text-primary mb-4">Submit Picks for {{ current_round.name }}</h2>

<form method="POST" id="picksForm">
    <div class="mb-3">
        <label for="round_id" class="form-label">Select Round</label>
        <div class="form-check">
            {% for round in all_open_rounds %}
            <div class="form-check mb-2">
                <input type="checkbox" class="form-check-input round-checkbox" name="round_id" value="{{ round.id }}"
                    id="round{{ round.id }}"
                    {% if round.id == current_round.id %}checked{% endif %}
                    onchange="selectRound(this)">
                <label class="form-check-label" for="round{{ round.id }}">{{ round.name }}</label>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="mb-3">
        <label for="user_id" class="form-label">Select User</label>
        <select class="form-select" id="user_id" name="user_id" onchange="this.form.submit()" required>
            <option value="" {% if not selected_user_id %}selected{% endif %}>-- Select a User --</option>
            {% for user in users %}
            <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>
                {{ user.username }}
            </option>
            {% endfor %}
        </select>
    </div>

    {% if games and selected_user %}
    <div class="table-responsive">
        <table class="table table-striped" id="picksTable">
            <thead class="table-dark">
                <tr>
                    <th>Team 1</th>
                    <th>Team 2</th>
                </tr>
            </thead>
            <tbody>
                {% for game in games %}
                <tr id="gameRow{{ game.id }}">
                    <td>
                        <div class="form-check" style="padding-left: 2.5rem;">
                            <input type="radio" class="form-check-input" name="game{{ game.id }}" value="{{ game.team1 }}"
                                id="game{{ game.id }}_team1"
                                {% if existing_picks[game.id] and existing_picks[game.id].picked_team == game.team1 %}checked{% endif %}
                                required>
                            <label class="form-check-label" for="game{{ game.id }}_team1">{{ game.team1 }}</label>
                        </div>
                    </td>
                    <td>
                        <div class="form-check" style="padding-left: 2.5rem;">
                            <input type="radio" class="form-check-input" name="game{{ game.id }}" value="{{ game.team2 }}"
                                id="game{{ game.id }}_team2"
                                {% if existing_picks[game.id] and existing_picks[game.id].picked_team == game.team2 %}checked{% endif %}
                                required>
                            <label class="form-check-label" for="game{{ game.id }}_team2">{{ game.team2 }}</label>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if current_round.name == 'Championship' %}
    <div class="mb-3">
        <label for="wager" class="form-label">Wager (Max: {{ selected_user.points }})</label>
        <input type="number" class="form-control" id="wager" name="wager" min="0" max="{{ selected_user.points }}"
            value="{% if existing_picks %}{{ existing_picks|first|attr('wager') }}{% else %}0{% endif %}">
    </div>
    {% endif %}
    <button type="submit" name="submit_picks" class="btn btn-primary">Submit Picks</button>
    {% else %}
    <div class="alert alert-warning">{% if not games %}No games available for this round yet{% else %}Please select a user{% endif %}</div>
    {% endif %}
</form>

<script>
    document.getElementById('picksForm').addEventListener('submit', function(event) {
        let allSelected = true;
        {% for game in games %}
            const team1Checked = document.getElementById('game{{ game.id }}_team1') ? document.getElementById('game{{ game.id }}_team1').checked : false;
            const team2Checked = document.getElementById('game{{ game.id }}_team2') ? document.getElementById('game{{ game.id }}_team2').checked : false;
            const row = document.getElementById('gameRow{{ game.id }}');
            if (!team1Checked && !team2Checked && row) {
                allSelected = false;
                row.classList.add('table-danger');
            } else if (row) {
                row.classList.remove('table-danger');
            }
        {% endfor %}
        if (!allSelected && event.submitter.name === 'submit_picks') {
            event.preventDefault();
            flashMessage('Please select one team per game.', 'danger');
        }
    });

    function flashMessage(message, category) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${category} fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerText = message;
        document.body.insertBefore(alertDiv, document.querySelector('.container'));
        setTimeout(() => alertDiv.remove(), 3000);
    }

    function selectRound(checkbox) {
        document.querySelectorAll('.round-checkbox').forEach(cb => {
            if (cb !== checkbox) cb.checked = false;
        });
        document.getElementById('picksForm').submit();
    }
</script>

<style>
    .form-check { padding: 10px; }
    .form-check:hover { background-color: #f0f0f0; }
    .table-danger { background-color: #f8d7da; }
    .round-checkbox { 
        margin-right: 10px; 
    }
    .form-check-label { 
        cursor: pointer; 
        color: #007bff; 
    }
    .form-check-input:checked + .form-check-label { 
        color: #0056b3; 
        font-weight: bold; 
    }
</style>
{% endblock %}