{% extends "base.html" %}
{% block title %}Submit Picks for Users - March Madness 2026{% endblock %}

{% block content %}
<div class="admin-picks-page">
    <div class="d-flex justify-content-between align-items-center mb-4 animate__animated animate__fadeIn">
        <h1 class="section-header mb-0">
            <i class="fas fa-user-edit"></i>
            Submit Picks for Users
        </h1>
        <a href="{{ url_for('admin') }}" class="btn btn-mm-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Admin
        </a>
    </div>

    <!-- Selectors -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="mm-card">
                <div class="mm-card-header">
                    <i class="fas fa-basketball"></i>
                    Select Round
                </div>
                <select class="form-select form-select-lg" id="roundSelect"
                        onchange="window.location.href='{{ url_for('admin_submit_picks') }}?round_id=' + this.value + '&user_id=' + document.getElementById('userSelect').value">
                    {% for round in all_open_rounds %}
                    <option value="{{ round.id }}" {% if current_round.id == round.id %}selected{% endif %}>
                        {{ round.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mm-card">
                <div class="mm-card-header">
                    <i class="fas fa-user"></i>
                    Select User
                </div>
                <select class="form-select form-select-lg" id="userSelect"
                        onchange="window.location.href='{{ url_for('admin_submit_picks') }}?round_id=' + document.getElementById('roundSelect').value + '&user_id=' + this.value">
                    <option value="">Choose a user...</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>
                        {{ user.username }} ({{ user.fun_name }})
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    {% if selected_user and current_round %}
    <!-- User Info -->
    <div class="mm-card mb-4">
        <div class="d-flex align-items-center gap-3">
            <img src="{{ url_for('static', filename=selected_user.picture) }}" class="selected-user-avatar"
                 onerror="this.src='https://ui-avatars.com/api/?name={{ selected_user.username }}&size=60'">
            <div>
                <h4 class="mb-0">{{ selected_user.fun_name or selected_user.username }}</h4>
                <p class="text-muted mb-0">@{{ selected_user.username }}</p>
            </div>
            <div class="ms-auto text-end">
                <div class="user-pts">{{ selected_user_points }} pts</div>
                <small class="text-muted">Total Points</small>
            </div>
        </div>
    </div>

    <form method="POST" id="submitPicksForm">
        <input type="hidden" name="round_id" value="{{ current_round.id }}">
        <input type="hidden" name="user_id" value="{{ selected_user.id }}">

        {% if current_round.name == 'Championship' %}
        <div class="mm-card mb-4 glow-orange">
            <div class="mm-card-header">
                <i class="fas fa-coins"></i>
                Championship Wager
            </div>
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label for="wagerInput" class="form-label">Wager Amount (Max: {{ selected_user_points }} pts)</label>
                    <input type="number" class="form-control form-control-lg" id="wagerInput" name="wager"
                           min="0" max="{{ selected_user_points }}" value="{{ wager or 0 }}">
                </div>
            </div>
        </div>
        {% endif %}

        <div class="mm-card mb-4">
            <div class="mm-card-header">
                <i class="fas fa-check-circle"></i>
                {{ current_round.short_name }} Picks
            </div>

            <div class="admin-picks-grid">
                {% for game in games %}
                <div class="pick-admin-card {% if error_game_id == game.id %}error{% endif %}" id="gameCard{{ game.id }}">
                    <div class="game-label">Game {{ loop.index }}</div>
                    <div class="teams-pick">
                        <label class="team-pick-option">
                            <input type="radio" name="game{{ game.id }}" value="{{ game.team1 }}"
                                   {% if existing_picks[game.id] and existing_picks[game.id].picked_team == game.team1 %}checked{% endif %}>
                            <span class="team-name">{{ game.team1 }}</span>
                        </label>
                        <span class="vs-badge">VS</span>
                        <label class="team-pick-option">
                            <input type="radio" name="game{{ game.id }}" value="{{ game.team2 }}"
                                   {% if existing_picks[game.id] and existing_picks[game.id].picked_team == game.team2 %}checked{% endif %}>
                            <span class="team-name">{{ game.team2 }}</span>
                        </label>
                    </div>
                    <div class="error-msg">Please select a team</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="submit-section">
            <button type="submit" name="submit_picks" class="btn btn-mm-primary btn-lg">
                <i class="fas fa-paper-plane me-2"></i>Submit Picks for {{ selected_user.username }}
            </button>
        </div>
    </form>
    {% else %}
    <div class="mm-card text-center py-5">
        <i class="fas fa-user-circle fa-4x text-muted mb-3"></i>
        <h4>Select a User</h4>
        <p class="text-muted">Choose a round and user above to submit picks on their behalf.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    .selected-user-avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--mm-primary); }
    .user-pts { font-family: 'Orbitron', monospace; font-size: 1.5rem; font-weight: 700; color: var(--mm-primary); }
    .admin-picks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem; }
    .pick-admin-card { background: var(--mm-dark); border: 1px solid var(--mm-border); border-radius: 10px; padding: 0.75rem; }
    .pick-admin-card.error { border-color: var(--mm-danger); animation: shake 0.5s ease; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
    .game-label { font-size: 0.7rem; color: var(--mm-text-muted); margin-bottom: 0.5rem; }
    .teams-pick { display: flex; align-items: center; gap: 0.4rem; }
    .team-pick-option { flex: 1; cursor: pointer; }
    .team-pick-option input { display: none; }
    .team-pick-option .team-name { display: flex; align-items: center; justify-content: center; height: 40px; padding: 0.4rem; background: var(--mm-card); border: 2px solid var(--mm-border); border-radius: 6px; text-align: center; font-weight: 500; transition: all 0.3s ease; font-size: 0.8rem; line-height: 1.1; }
    .team-pick-option input:checked + .team-name { background: rgba(255, 107, 53, 0.15); border-color: var(--mm-primary); color: var(--mm-primary); }
    .vs-badge { font-family: 'Orbitron', monospace; font-size: 0.65rem; color: var(--mm-text-muted); }
    .error-msg { display: none; margin-top: 0.5rem; color: var(--mm-danger); font-size: 0.85rem; }
    .pick-admin-card.error .error-msg { display: block; }
    .submit-section { text-align: center; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('submitPicksForm')?.addEventListener('submit', function(e) {
        let hasError = false;
        let firstError = null;
        document.querySelectorAll('.pick-admin-card').forEach(card => {
            const gameId = card.id.replace('gameCard', '');
            const checked = document.querySelector(`input[name="game${gameId}"]:checked`);
            if (!checked) {
                card.classList.add('error');
                hasError = true;
                if (!firstError) firstError = card;
            } else {
                card.classList.remove('error');
            }
        });
        if (hasError) {
            e.preventDefault();
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
</script>
{% endblock %}
